import{d7 as We,d4 as De,d5 as _e,db as Le,dc as Re,bu as Qe,cA as Oe,c as ne,h as re,dg as ie,bK as Ye,de as S,df as F,da as x,di as se,bY as P,dh as Ze,d6 as d}from"./app.Dbs6V_q1.js";import{F as Ve}from"./CheckCircleIcon.DG4NyxCY.js";import{r}from"./index.Crn7-fJZ.js";import{c as Xe,n as Je,s as Ke}from"./Layouts-BlFm53ED.DNAcEX9b.js";import{b as oe}from"./ModalHeader-CSfzkWxZ.KQF0IT9H.js";import{o as ze}from"./ScreenHeader-CHmc4-Lu.CDB8Kfz5.js";import{t as de}from"./FundWalletMethodHeader-Dujd1j7J.DOTw7rnz.js";import{t as Ge}from"./index-Dq_xe9dz.CYFAvuPJ.js";import{c as et,t as tt}from"./useGetTokenPrice-YObgUU6L.Bdidc-9R.js";import{t as ce,a as at}from"./transfer-6YztDh-t.DU6hH7CZ.js";import{t as nt}from"./formatErc20TokenAmount-BuPk9xcy.CkAr4Oc0.js";import{n as rt,o as le,c as R,l as it}from"./ethers-DrSqg5wi.D-a06N_R.js";import{t as ue}from"./analytics-mkkvFRju.DOXuftJB.js";import{o as Q,u as me,d as fe,f as st}from"./reservoir-0wfhnc0j.e4oV4U26.js";import{Q as ot,Z as dt}from"./BridgeNetworkSelectionView-0VRZoDMv.C8_i9FW3.js";import{n as ct}from"./getErc20Balance-D0MGUaOw.CZLXP-aV.js";import{I as lt}from"./TransferOrBridgeLoadingScreen-gM_oel5i.B9Paf-ub.js";import{p as ut}from"./parseEther.DWtwDPWT.js";import{c as mt}from"./custom.BLgW5Lf4.js";import"./useGetSolPrice-DwwjjGbd.Cs3YiPXK.js";import"./Value-tcJV9e0L.CCQPdIyi.js";import"./LoadingSkeleton-U6-3yFwI.DhgKuR2U.js";import"./ErrorMessage-D8VaAP5m.NPlgZ3Xt.js";import"./Subtitle-CV-2yKE4.DJhYHDeo.js";import"./Title-BnzYV3Is.B74pnAvd.js";import"./WalletIcon.DW8etFtk.js";import"./getChainName-DjpPdUSc.c2urPd0g.js";import"./Chip-D2-wZOHJ.DezdPRVM.js";import"./shared-FM0rljBt.uRznKemR.js";import"./ChevronDownIcon.zw1eklKi.js";import"./styles-C3H3yhVT.DXoQsb_B.js";import"./LinkPasskeyScreen-jzRj6Yq0.CHUIblrj.js";import"./TodoList-CgrU7uwu.CdzoNajJ.js";import"./createLucideIcon.RSj0tFkk.js";import"./check.BWO2M5QN.js";import"./ScreenLayout-C2Le_YIv.CCTYs10k.js";import"./Screen-5StC6JLQ.BNbtfsff.js";import"./circle-check-big.BEG3gtjL.js";import"./fingerprint-pattern.Bk_3pvPW.js";import"./formatters.DtIZsRmK.js";import"./InjectedWalletIcon-DLcYOGDj.CyAbXwSp.js";import"./Address-BuCMjci7.5xYW3BaW.js";import"./copy.Ukg_M5w7.js";import"./GlobeAltIcon.TtWhTJWd.js";import"./parseUnits.Di_CbW2l.js";const ra={component:()=>{let{rpcConfig:j,appId:y,closePrivyModal:he,createAnalyticsEvent:O}=We(),{navigate:pe,setModalData:q,data:o}=De(),Y=_e(),{wallets:ge}=Le(),[ve,ye]=r.useState(!1),[C,Ce]=r.useState(0n),[Z,V]=r.useState(!1),[H,g]=r.useState(null),[Ie,M]=r.useState(null),[b,be]=r.useState([]),[X,Te]=r.useState(0),[J,N]=r.useState(!1),[W,B]=r.useState(!1),[K,D]=r.useState(!1),[_,z]=r.useState(!1),[we,Ee]=r.useState(),[Se,G]=r.useState();if(!o?.funding||o.funding.chainType!=="ethereum")throw Error("Invalid funding data");let{erc20ContractInfo:s,chain:t,connectedWallet:ee}=o.funding,h=o.funding.address,m=o.funding.erc20Address,[T,xe]=r.useState(o.funding.amount);r.useEffect((()=>{m&&!s&&g(Error("Unable to fetch token details"))}),[]);let c=!!m&&!!s,f=c?BigInt(parseFloat(T)*10**s.decimals):ut(T),a=(ee?.type==="ethereum"?ee:void 0)??ge[0],Ne=Re(a?.walletClientType||"unknown"),te=Ne?.name||"wallet",[v,$e]=r.useState(null);r.useEffect((()=>{(async()=>{if(!a)return;let n=await a.getEthereumProvider();$e(Qe({account:a.address,transport:mt(n)}).extend(Oe))})().catch(console.error)}),[a]);let[Ae,Fe]=r.useState(0n);r.useEffect((()=>{ne({chain:t,transport:re(ie(t,j,y))}).getBalance({address:h}).then(Fe).catch(console.error)}),[]);let[je,Be]=r.useState(0n);r.useEffect((()=>{c&&ct({chain:t,address:h,appId:y,rpcConfig:j,erc20Address:m}).then((n=>Be(n.balance))).catch(console.error)}),[]);let{tokenPrice:w}=et(t.id),[i,U]=r.useState({to:h,chain:t,value:f,data:void 0});r.useEffect((()=>{(async()=>{let n,u;if(!v||!a||J||K)return;N(!0);let I=ne({chain:i.chain,transport:re(ie(i.chain,j,y))});if(c&&!i.data)return await I.simulateContract({address:m,chain:i.chain,abi:ce,functionName:"transfer",args:[h,f],account:a.address}).catch((l=>{if(l?.cause?.name==="ContractFunctionZeroDataError"||l?.message?.includes("returned no data"))return I.simulateContract({address:m,chain:i.chain,abi:at,functionName:"transfer",args:[h,f],account:a.address}).catch((E=>{console.warn("Simulated token transfer failed with error, fetching bridge options.",E)}));console.warn("Simulated token transfer failed with error, fetching bridge options.",l)}))?(N(!1),void U({to:m,chain:i.chain,data:Ye({abi:ce,functionName:"transfer",args:[h,f]}),value:"0x0"})):(N(!1),void V(!0));try{n=await I.prepareTransactionRequest({account:a.address,to:i.to,chain:i.chain,data:i.data,value:BigInt(i.value??0)})}catch(l){if(console.error(l),b.length>1)M(l.shortMessage??"Something went wrong");else if(W&&b.length===0)return void g(new S(`Wallet ${F(a.address)} does not have enough funds.`,void 0,x.INSUFFICIENT_BALANCE))}if(!n)return N(!1),void V(!0);N(!1),D(!0),ye(!0),Ce(n.gas);try{await v.switchChain({id:i.chain.id})}catch{await v.addChain({chain:i.chain}),await v.switchChain({id:i.chain.id})}try{u=await v.sendTransaction(n)}catch(l){if(console.error(l),l.name==="TransactionExecutionError")if(b.length<1){let E=l.shortMessage;(l.shortMessage.includes("rejected the request")||l.details.includes("rejected the request"))&&(E="User rejected the request."),g(new S(E,void 0,x.TRANSACTION_FAILURE))}else M(l.shortMessage??"Something went wrong")}if(u)return await v.waitForTransactionReceipt({hash:u}),D(!1),W?(Ee(u),void G("pending")):(z(!0),q(se(o,"completed",u,a?.walletClientType,c,s,t)),void O({eventName:ue,payload:{provider:"external",status:"success",txHash:u,address:a.address,chainId:i.chain.id,chainType:"ethereum",value:i.value?P(BigInt(i.value),s?.decimals??18):void 0,token:s?.symbol??m??"ETH",destinationAddress:h,destinationChainId:t.id,destinationChainType:"ethereum",destinationValue:f?P(f,s?.decimals??18):void 0,destinationToken:s?.symbol??m??t.nativeCurrency.name}}));D(!1)})().catch(console.error)}),[v,i]),r.useEffect((()=>{(async()=>{if(!Z||!v||!a)return;let n=tt(Y.chains).filter((e=>e.id!==t.id&&!!e.testnet==!!t.testnet));c&&n.unshift(t);let u=await ot({chains:n,address:a.address,appId:y,rpcConfig:j,includeUsdc:o.funding?.isUSDC}),I=c?u.filter((e=>e.balance>0n)):u.filter((e=>e.balance>f)),l=c&&u.every((e=>e.balance===0n));if(I.length<1)return void g(new S(l?`Wallet ${F(a.address)} doesn't have enough funds to cover gas fees. Top up your wallet and try again.`:`Wallet ${F(a.address)} does not have enough funds.`,void 0,x.INSUFFICIENT_BALANCE));I.sort(((e,A)=>Number(c?(A.erc20Balance??0n)-(e.erc20Balance??0n):A.balance-e.balance)));let E=I.flatMap((e=>{let A=[{...e,isErc20Quote:!1,isTestnet:!!t.testnet,input:Q({appId:y,amount:f.toString(),user:a.address,recipient:h,destinationChainId:t.id,destinationCurrency:m,originChainId:e.chain.id})}];return c&&m&&(e.erc20Balance??0n)>=f&&A.push({...e,isErc20Quote:!0,isTestnet:!!t.testnet,input:Q({appId:y,amount:f.toString(),user:a.address,recipient:h,destinationChainId:t.id,destinationCurrency:m,originChainId:e.chain.id,originCurrency:e.erc20Address})}),A})),ae=(await Promise.allSettled(E.map((async e=>({...e,quote:await me(e)}))))).filter((e=>e.status==="fulfilled")).map((e=>e.value));if(ae.length<1)return void g(new S(`Wallet ${F(a.address)} does not have enough funds.`,void 0,x.INSUFFICIENT_BALANCE));let L=ae.map((e=>({bridgeTx:fe(e.quote),balance:e.balance,chain:e.chain,erc20Balance:e.erc20Balance,isErc20Quote:e.isErc20Quote}))).filter((e=>!!e.bridgeTx));if(L.length>1)return void be(L);let $=L[0];$?(B(!0),U({data:$.bridgeTx.data,to:$.bridgeTx.to,value:$.bridgeTx.value,chain:$.chain})):g(new S(`Wallet ${F(a.address)} does not have enough funds.`,void 0,x.INSUFFICIENT_BALANCE))})().catch(console.error)}),[Z]),st({transactionHash:we,isTestnet:!!t.testnet,bridgingStatus:Se,setBridgingStatus:G,onSuccess({transactionHash:n}){B(!1),z(!0),q(se(o,"completed",n,a?.walletClientType,c,s,t)),O({eventName:ue,payload:{provider:"external",status:"success",txHash:n,address:a?.address,chainId:i.chain.id,chainType:"ethereum",value:i.value?P(BigInt(i.value),s?.decimals??18):void 0,token:s?.symbol??m??"ETH",destinationAddress:h,destinationChainId:t.id,destinationChainType:"ethereum",destinationValue:f?P(f,s?.decimals??18):void 0,destinationToken:s?.symbol??m??t.nativeCurrency.name}})},onFailure({error:n}){B(!1),g(n)}}),r.useEffect((()=>{H&&(q({funding:o?.funding,solanaFundingData:o?.solanaFundingData,sendTransaction:o?.sendTransaction,errorModalData:{error:H,previousScreen:"TransferFromWalletScreen"}}),pe("ErrorScreen",!1))}),[H]);let Ue=!c&&w?rt(T??"0",w):void 0,k=c?C:it([C,f]),ke=k&&w?le(k,w):void 0,Pe=k?R(k,o?.funding?.erc20Address?o?.funding?.erc20ContractInfo?.symbol||"ETH":o?.funding?.chain.nativeCurrency.symbol||"ETH"):void 0,qe=C&&w?le(C,w):void 0,He=C?R(C,t?.nativeCurrency?.symbol||"ETH"):void 0;if(r.useEffect((()=>{if(!_)return;let n=setTimeout(he,Ze);return()=>clearTimeout(n)}),[_]),_)return d.jsxs(d.Fragment,{children:[d.jsx(de,{}),d.jsx(Xe,{}),d.jsxs(Je,{children:[d.jsx(Ve,{color:"var(--privy-color-success)",width:"64px",height:"64px"}),d.jsx(ze,{title:"Success!",description:`Youâ€™ve successfully added ${T} ${c?s.symbol:t.nativeCurrency.symbol} to your ${Y.name} wallet. It may take a minute before the funds are available to use.`})]}),d.jsx(Ke,{}),d.jsx(oe,{})]});let Me=c?`${nt({amount:je,decimals:s.decimals})}  ${s.symbol}`:R(Ae,t.nativeCurrency.symbol,3,!0),p=b[X];return b.length>1&&p?d.jsx(dt,{displayName:te,configuredFundingChain:t,erc20ContractInfo:s,formattedBalance:Me,fundingAmount:T,fundingCurrency:c?s.symbol:t.nativeCurrency.symbol,fundingAmountInUsd:Ue,options:b,selectedOption:p,isPreparing:J,isSubmitting:K,addressToFund:h,fundingWalletAddress:a?.address||"",errorMessage:Ie,onSubmit:()=>{o.funding?.amount!==T?(async function(){if(a&&p)try{let n=await me({isTestnet:!!t.testnet,input:Q({appId:y,amount:f.toString(),user:a.address,recipient:h,destinationChainId:t.id,destinationCurrency:m,originChainId:p.chain.id})}),u=fe(n);if(!u)throw Error("Invalid transaction request");B(!0),U({data:u.data,to:u.to,value:u.value,chain:p.chain})}catch(n){console.error(n),g(new S("Unable to fetch quotes for bridging",n,x.INSUFFICIENT_BALANCE))}})().catch(console.error):U({to:p.bridgeTx.to,data:p.bridgeTx.data,value:p.bridgeTx.value,chain:p.chain})},onSelect:n=>{n!==X&&(M(null),Te(n))},onAmountChange:xe}):ve&&C&&a&&o?.funding?d.jsx(lt,{walletClientType:a?.walletClientType||"unknown",displayName:te,addressToFund:h,isBridging:W,isErc20Flow:c,totalPriceInUsd:ke,totalPriceInNativeCurrency:Pe,gasPriceInUsd:qe,gasPriceInNativeCurrency:He,chainId:t.id,chainName:t.name}):d.jsxs(d.Fragment,{children:[d.jsx(de,{}),d.jsx(Ge,{}),d.jsx("div",{style:{marginTop:"1rem"}}),d.jsx(oe,{})]})}};export{ra as AwaitingExternalEthereumTransferScreen,ra as default};
